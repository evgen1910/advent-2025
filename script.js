/* ===========================
   –î–ê–ù–ù–´–ï –ê–î–í–ï–ù–¢–ê (–≤—à–∏—Ç—ã)
   =========================== */

const adventData = {
  "2025-12-15": {
    dateLabel: "15.12.2025",
    question: "–ö–∞–∫–æ–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–µ —Å—Ä–µ–¥—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ì—Ä–∏–Ω—á –¥–ª—è –∫—Ä–∞–∂–∏ –ø–æ–¥–∞—Ä–∫–æ–≤?",
    answers: ["—Å–∞–Ω–∏"],
    giftName: "15_mems.pdf",
    giftUrl: "https://drive.google.com/file/d/15Ws-FihOM6pe0pejVdbqxKuJ5cLJqkfN/view?usp=sharing"
  },
  "2025-12-16": {
    dateLabel: "16.12.2025",
    question: "–í –∫–∞–∫–æ–π —Å—Ç—Ä–∞–Ω–µ –Ω–∞ –ù–æ–≤—ã–π –≥–æ–¥ –ø—Ä–∏–Ω—è—Ç–æ –µ—Å—Ç—å 12 –≤–∏–Ω–æ–≥—Ä–∞–¥–∏–Ω –ø–æ–¥ –±–æ–π –∫—É—Ä–∞–Ω—Ç–æ–≤, –∑–∞–≥–∞–¥—ã–≤–∞—è –∂–µ–ª–∞–Ω–∏–µ –Ω–∞ –∫–∞–∂–¥—ã–π –º–µ—Å—è—Ü?",
    answers: ["–∏—Å–ø–∞–Ω–∏—è"],
    giftName: "16_litres.pdf",
    giftUrl: "https://drive.google.com/file/d/1Gq0gTz6OIIeFxqNUfeRG_0HQ3DkDCYwQ/view?usp=sharing"
  },
  "2025-12-17": {
    dateLabel: "17.12.2025",
    question: "–ö–∞–∫ –∑–æ–≤—É—Ç –≥–µ—Ä–æ—è –¥–∏—Å–Ω–µ–µ–≤—Å–∫–æ–≥–æ –º—É–ª—å—Ç–∏–∫–∞, –∫–æ–º—É –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç —Å–ª–æ–≤–∞ \"–û–π, —Å–º–æ—Ç—Ä–∏—Ç–µ, —è - —à–∞—à–ª—ã—á–æ–∫!\" ?",
    answers: ["–æ–ª–∞—Ñ"],
    giftName: "A late-night luxury bar",
    giftUrl: "https://open.spotify.com/playlist/3laBYMG32oGIpMmKNoFUDs"
  },
  "2025-12-18": {
    dateLabel: "18.12.2025",
    question: "–í –∫–∞–∫–æ–π —Å—Ç—Ä–∞–Ω–µ –Ω–∞ –ù–æ–≤—ã–π –≥–æ–¥ (–ù–æ–≤—ã–π –≥–æ–¥ –ø–æ –ª—É–Ω–Ω–æ–º—É –∫–∞–ª–µ–Ω–¥–∞—Ä—é) –Ω–µ–ª—å–∑—è –ø–æ–¥–º–µ—Ç–∞—Ç—å –ø–æ–ª, —á—Ç–æ–±—ã –Ω–µ –≤—ã–º–µ—Å—Ç–∏ —É–¥–∞—á—É?",
    answers: ["–∫–∏—Ç–∞–π"],
    giftName: "18_king.pdf",
    giftUrl: "https://drive.google.com/file/d/1c3iueehQI8tNy7iva199JPIhqIRVfpqH/view?usp=sharing"
  },
  "2025-12-19": {
    dateLabel: "19.12.2025",
    question: "–ß—Ç–æ –≤ –ò—Å–ª–∞–Ω–¥–∏–∏ –¥–µ—Ç–∏ –∫–ª–∞–¥—É—Ç –Ω–∞ –ø–æ–¥–æ–∫–æ–Ω–Ω–∏–∫ –≤ —Ä–æ–∂–¥–µ—Å—Ç–≤–µ–Ω—Å–∫—É—é –Ω–æ—á—å, —á—Ç–æ–±—ã —Ç—É–¥–∞ –ø–æ–ø–∞–ª–∏ –ø–æ–¥–∞—Ä–∫–∏ –æ—Ç 13-—Ç–∏ –º–µ—Å—Ç–Ω—ã—Ö –î–µ–¥–æ–≤ –ú–æ—Ä–æ–∑–æ–≤?",
    answers: ["–±–æ—Ç–∏–Ω–æ–∫"],
    giftName: "–∫–ª–∏–ø –Ω–æ–≤—ã–π-–Ω–æ–≤—ã–π –≥–æ–¥",
    giftUrl: "https://www.youtube.com/watch?v=1Xn5p6fVzWI&list=RD1Xn5p6fVzWI&start_radio=1"
  },
  "2025-12-20": {
    dateLabel: "20.12.2025",
    question: "–ö—Ç–æ –∏–∑ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π ¬´–ì–∞—Ä—Ä–∏ –ü–æ—Ç—Ç–µ—Ä–∞¬ª –ø–æ–¥–∞—Ä–∏–ª –ì–∞—Ä—Ä–∏ –Ω–∞ –†–æ–∂–¥–µ—Å—Ç–≤–æ –ú–∞–Ω—Ç–∏—é-–Ω–µ–≤–∏–¥–∏–º–∫—É?",
    answers: ["–¥–∞–º–±–ª–¥–æ—Ä"],
    giftName: "Broken but Standing",
    giftUrl: "https://open.spotify.com/playlist/7bNg2XDsAQQ9fVv37lV9TA"
  },
  "2025-12-21": {
    dateLabel: "21.12.2025",
    question: "–í –∫–∞–∫–æ–π —Å—Ç—Ä–∞–Ω–µ –Ω–∞ –†–æ–∂–¥–µ—Å—Ç–≤–æ –ø—Ä–∏–Ω—è—Ç–æ —Å—Ç–∞–≤–∏—Ç—å –Ω–∞ —Å—Ç–æ–ª –∂–∞—Ä–µ–Ω–æ–≥–æ... –∫–∞—Ä–ø–∞?",
    answers: ["—á–µ—Ö–∏—è"],
    giftName: "21_king.pdf",
    giftUrl: "https://drive.google.com/file/d/1cGEqLKXtkD6i3eiJXWARiX0jRw77jsWa/view?usp=sharing"
  },
  "2025-12-22": {
    dateLabel: "22.12.2025",
    question: "–ö–∞–∫–æ–π –ø–µ—Ä—Å–æ–Ω–∞–∂ –∏–∑ ¬´–í–ª–∞—Å—Ç–µ–ª–∏–Ω–∞ –ö–æ–ª–µ—Ü¬ª —Å—Ç–∞–ª —Ä–æ–∂–¥–µ—Å—Ç–≤–µ–Ω—Å–∫–∏–º —Å–∏–º–≤–æ–ª–æ–º –¥–ª—è —Ñ–∞–Ω–∞—Ç–æ–≤ ?",
    answers: ["–≥–µ–Ω–¥–∞–ª—å—Ñ"],
    giftName: "–∏–≥—Ä–∞",
    giftUrl: "https://evgen1910.github.io/dima-workday-game/"
  },
  "2025-12-23": {
    dateLabel: "23.12.2025",
    question: "–í –∫–∞–∫–æ–π –µ–≤—Ä–æ–ø–µ–π—Å–∫–æ–π —Å—Ç—Ä–∞–Ω–µ –Ω–∞ –†–æ–∂–¥–µ—Å—Ç–≤–æ –ø—Ä–∏–Ω—è—Ç–æ –ø—Ä—è—Ç–∞—Ç—å –º–µ—Ç–ª—É ‚Äî —á—Ç–æ–±—ã –≤–µ–¥—å–º—ã –Ω–µ —É–Ω–µ—Å–ª–∏ –µ—ë –¥–ª—è —Å–≤–æ–∏—Ö –ø–æ–ª—ë—Ç–æ–≤?",
    answers: ["–Ω–æ—Ä–≤–µ–≥–∏—è"],
    giftName: "23_hor.pdf",
    giftUrl: "https://drive.google.com/file/d/1Xb02kf_3HeF7vxIFlRBh5FQmsPp7cdIl/view?usp=sharing"
  },
  "2025-12-24": {
    dateLabel: "24.12.2025",
    question: "–°–∞–º—ã–π –Ω–æ–≤–æ–≥–æ–¥–Ω–∏–π —Ñ–∏–ª—å–º —Å –ë—Ä—é—Å—Å–æ–º –£–∏–ª–ª–∏—Å–æ–º: (–≤ 2 —Å–ª–æ–≤–∞)?",
    answers: ["–∫—Ä–µ–ø–∫–∏–π –æ—Ä–µ—à–µ–∫"],
    giftName: "24_meditation.mp3",
    giftUrl: "https://drive.google.com/file/d/1FYMrOj9v5IgLeGXE1dEPpVNIkOhx_pdu/view?usp=sharing"
  },
  "2025-12-25": {
    dateLabel: "25.12.2025",
    question: "–í –∫–∞–∫–æ–π —Å—Ç—Ä–∞–Ω–µ –≥–ª–∞–≤–Ω—ã–π –∑–∏–º–Ω–∏–π –ø–µ—Ä—Å–æ–Ω–∞–∂ ‚Äî –∫–æ–∑—ë–ª, –∞ –Ω–µ –î–µ–¥ –ú–æ—Ä–æ–∑?",
    answers: ["—Ñ–∏–Ω–ª—è–Ω–¥–∏—è"],
    giftName: "The Kitchen. A Cigarette. A Heart-to-Heart Talk",
    giftUrl: "https://open.spotify.com/playlist/6ESOAs0TbqHaCpePLDnMTU"
  },
  "2025-12-26": {
    dateLabel: "26.12.2025",
    question: "–í –∫–∞–∫–æ–π —Å—Ç—Ä–∞–Ω–µ –≤ –Ω–æ–≤–æ–≥–æ–¥–Ω—é—é –Ω–æ—á—å –ø—Ä–∏–Ω—è—Ç–æ –≤—ã–±—Ä–∞—Å—ã–≤–∞—Ç—å –∏–∑ –æ–∫–æ–Ω —Å—Ç–∞—Ä—É—é –º–µ–±–µ–ª—å –∏ –Ω–µ–Ω—É–∂–Ω—ã–µ –≤–µ—â–∏?",
    answers: ["–∏—Ç–∞–ª–∏—è"],
    giftName: "26_stihi.pdf",
    giftUrl: "https://drive.google.com/file/d/1EnJEarD92D3esdQSyLXnCbisLlor28eq/view?usp=sharing"
  },
  "2025-12-27": {
    dateLabel: "27.12.2025",
    question: "–ö–∞–∫ –∑–æ–≤—É—Ç ¬´–∑–ª–æ–≥–æ¬ª –¥–≤–æ–π–Ω–∏–∫–∞ –°–∞–Ω—Ç—ã –≤ –∞–≤—Å—Ç—Ä–∏–π—Å–∫–æ–π –∏ –Ω–µ–º–µ—Ü–∫–æ–π —Ç—Ä–∞–¥–∏—Ü–∏—è—Ö, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–µ–ø–æ—Å–ª—É—à–Ω—ã—Ö –¥–µ—Ç–µ–π?",
    answers: ["–∫—Ä–∞–º–ø—É—Å"],
    giftName: "27_recipe.pdf",
    giftUrl: "https://drive.google.com/file/d/19sBvPGZh1T0cX7gQtxe-yziUkk1z2SO9/view?usp=sharing"
  },
  "2025-12-28": {
    dateLabel: "28.12.2025",
    question: "–í –∫–∞–∫–æ–π –∞–∑–∏–∞—Ç—Å–∫–æ–π —Å—Ç—Ä–∞–Ω–µ –Ω–∞ –ù–æ–≤—ã–π –≥–æ–¥ –ø—Ä–∏–Ω—è—Ç–æ –æ—Ç–ø—É—Å–∫–∞—Ç—å –∂–∏–≤—ã—Ö –∫–∞—Ä–ø–æ–≤ –≤ —Ä–µ–∫—É, —Å—á–∏—Ç–∞—è, —á—Ç–æ –Ω–∞ –Ω–∏—Ö —É–ø–ª—ã–≤–∞—é—Ç –≤—Å–µ –±–µ–¥—ã?",
    answers: ["–≤—å–µ—Ç–Ω–∞–º"],
    giftName: "Fuck it, let‚Äôs dance",
    giftUrl: "https://open.spotify.com/playlist/4IMcQvry1CFKrJwF2kgw3K"
  },
  "2025-12-29": {
    dateLabel: "29.12.2025",
    question: "–ö–∞–∫–æ–π —Ñ—Ä—É–∫—Ç —è–≤–ª—è–µ—Ç—Å—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º –ø–æ–¥–∞—Ä–∫–æ–º –Ω–∞ –∫–∏—Ç–∞–π—Å–∫–∏–π –ù–æ–≤—ã–π –≥–æ–¥ –∫–∞–∫ –ø–æ–∂–µ–ª–∞–Ω–∏–µ –±–æ–≥–∞—Ç—Å—Ç–≤–∞?",
    answers: ["–º–∞–Ω–¥–∞—Ä–∏–Ω"],
    giftName: "28_wikium.pdf",
    giftUrl: "https://drive.google.com/file/d/1E1MhC06ub7Szh9vkmf3003xhjbRcs1Pa/view?usp=sharing"
  },
  "2025-12-30": {
    dateLabel: "30.12.2025",
    question: "–ö–æ–≥–æ —Å—ã–≥—Ä–∞–ª —Ä–æ–¥–Ω–æ–π –±—Ä–∞—Ç –ú–∞–∫–æ–ª–µ—è –ö–∞–ª–∫–∏–Ω–∞ –≤ —Ñ–∏–ª—å–º–µ –û–¥–∏–Ω –î–æ–º–∞?",
    answers: ["—Ñ—É–ª–ª–µ—Ä"],
    giftName: "New Year Cooking Playlist",
    giftUrl: "https://open.spotify.com/playlist/6l6AKJhnRefQ1JlanzFf0R"
  },
  "2025-12-31": {
    dateLabel: "31.12.2025",
    question: "–ö–µ–º –±—ã–ª –ú–∏—Å—Ç–µ—Ä –•—ç–Ω–∫–∏ –∏–∑ –ø–µ—Ä–≤–æ–≥–æ —Ä–æ–∂–¥–µ—Å—Ç–≤–µ–Ω—Å–∫–æ–≥–æ —ç–ø–∏–∑–æ–¥–∞ –Æ–∂–Ω–æ–≥–æ –ø–∞—Ä–∫–∞?",
    answers: ["–∫–∞–∫–∞—à–∫–∞"],
    giftName: "–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞",
    giftUrl: "https://drive.google.com/file/d/1bygZpTNiGqbyCHQQewskRVoCdu69pcNM/view?usp=sharing"
  }
};

// –ü–æ—Ä—è–¥–æ–∫ —à–∞—Ä–æ–≤ + –ø–æ–∑–∏—Ü–∏–∏ –Ω–∞ —Å—Ü–µ–Ω–µ (–≤ % –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
const ornamentLayout = [
  { key: "2025-12-15", x: 14, y: 46 },
  { key: "2025-12-16", x: 24, y: 58 },
  { key: "2025-12-17", x: 33, y: 44 },
  { key: "2025-12-18", x: 40, y: 60 },
  { key: "2025-12-19", x: 48, y: 42 },
  { key: "2025-12-20", x: 56, y: 57 },
  { key: "2025-12-21", x: 63, y: 45 },
  { key: "2025-12-22", x: 72, y: 58 },
  { key: "2025-12-23", x: 80, y: 44 },
  { key: "2025-12-24", x: 18, y: 30 },
  { key: "2025-12-25", x: 28, y: 28 },
  { key: "2025-12-26", x: 38, y: 30 },
  { key: "2025-12-27", x: 50, y: 26 },
  { key: "2025-12-28", x: 62, y: 30 },
  { key: "2025-12-29", x: 74, y: 28 },
  { key: "2025-12-30", x: 86, y: 30 },
  { key: "2025-12-31", x: 92, y: 58 }
];

/* ===========================
   –•–ï–õ–ü–ï–†–´
   =========================== */

const STORAGE_KEY = "advent2025_opened_v1";

function loadOpened() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    return raw ? JSON.parse(raw) : {};
  } catch {
    return {};
  }
}
function saveOpened(map) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(map));
}

function normalizeText(s) {
  return (s ?? "")
    .toString()
    .trim()
    .toLowerCase()
    .replace(/\s+/g, " ");
}

// –ø—Ä–∏–Ω–∏–º–∞–µ—Ç "–î–î.–ú–ú.–ì–ì–ì–ì" –∏–ª–∏ "–ì–ì–ì–ì-–ú–ú-–î–î"
function parseUserDate(input) {
  const v = (input || "").trim();

  // YYYY-MM-DD
  const iso = v.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (iso) return `${iso[1]}-${iso[2]}-${iso[3]}`;

  // DD.MM.YYYY
  const ru = v.match(/^(\d{2})\.(\d{2})\.(\d{4})$/);
  if (ru) return `${ru[3]}-${ru[2]}-${ru[1]}`;

  return null;
}

function formatDateLabel(iso) {
  const d = adventData[iso]?.dateLabel;
  if (d) return d;
  // fallback
  const m = iso.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  return m ? `${m[3]}.${m[2]}.${m[1]}` : iso;
}

function giftTypeByUrl(url, name) {
  const u = (url || "").toLowerCase();
  const n = (name || "").toLowerCase();
  if (n.endsWith(".pdf") || u.includes(".pdf")) return "pdf";
  if (n.endsWith(".mp3") || u.includes(".mp3")) return "audio";
  if (u.includes("spotify.com")) return "spotify";
  if (u.includes("youtube.com") || u.includes("youtu.be")) return "youtube";
  return "link";
}

/* ===========================
   DOM
   =========================== */

const ornamentsEl = document.querySelector(".ornaments");

// modal elements
const modalOverlay = document.getElementById("modalOverlay");
const modalClose = document.getElementById("modalClose");
const modalTitle = document.getElementById("modalTitle");
const modalSubtitle = document.getElementById("modalSubtitle");
const modalBadge = document.getElementById("modalBadge");

const stepDate = document.getElementById("stepDate");
const stepQuestion = document.getElementById("stepQuestion");
const stepGift = document.getElementById("stepGift");

const dateInput = document.getElementById("dateInput");
const btnCheckDate = document.getElementById("btnCheckDate");
const btnCancel = document.getElementById("btnCancel");
const dateNote = document.getElementById("dateNote");

const letterDate = document.getElementById("letterDate");
const questionText = document.getElementById("questionText");
const answerInput = document.getElementById("answerInput");
const btnCheckAnswer = document.getElementById("btnCheckAnswer");
const btnBack = document.getElementById("btnBack");
const answerNote = document.getElementById("answerNote");

const giftNameEl = document.getElementById("giftName");
const giftDescEl = document.getElementById("giftDesc");
const giftActions = document.getElementById("giftActions");
const btnCloseAfterGift = document.getElementById("btnCloseAfterGift");

// how modal
const howOverlay = document.getElementById("howOverlay");
const btnHow = document.getElementById("btnHow");
const howClose = document.getElementById("howClose");
const howOk = document.getElementById("howOk");

// reset
const btnReset = document.getElementById("btnReset");

let openedMap = loadOpened();
let activeKey = null;

/* ===========================
   –†–ï–ù–î–ï–† –®–ê–†–û–í
   =========================== */

function colorVariant(i) {
  const variants = [
    "hue-0", "hue-1", "hue-2", "hue-3", "hue-4", "hue-5"
  ];
  return variants[i % variants.length];
}

function createOrnaments() {
  ornamentsEl.innerHTML = "";

  ornamentLayout.forEach((item, idx) => {
    const data = adventData[item.key];
    if (!data) return;

    const wrap = document.createElement("button");
    wrap.className = "ornament";
    wrap.type = "button";
    wrap.style.left = `${item.x}%`;
    wrap.style.top = `${item.y}%`;
    wrap.style.transform = `translate(-50%, -50%)`;
    wrap.setAttribute("aria-label", `–®–∞—Ä–∏–∫ ${data.dateLabel}`);

    const ball = document.createElement("div");
    ball.className = "ball " + colorVariant(idx);

    // –¥–æ–±–∞–≤–∏–º –ª—ë–≥–∫–∏–π –æ—Ç—Ç–µ–Ω–æ–∫ —á–µ—Ä–µ–∑ filter hue-rotate
    const hue = (idx * 22) % 360;
    ball.style.filter = `hue-rotate(${hue}deg)`;

    if (openedMap[item.key]) {
      ball.classList.add("ball--opened");
    }

    const label = document.createElement("div");
    label.className = "ballLabel";
    label.textContent = data.dateLabel;

    wrap.appendChild(ball);
    wrap.appendChild(label);

    wrap.addEventListener("click", () => openForDate(item.key));

    ornamentsEl.appendChild(wrap);
  });
}

/* ===========================
   –ú–û–î–ê–õ–ö–ê: –û–¢–ö–†–´–¢–ò–ï
   =========================== */

function openModal() {
  modalOverlay.classList.add("isOpen");
  modalOverlay.setAttribute("aria-hidden", "false");
  document.body.style.overflow = "hidden";
}

function closeModal() {
  modalOverlay.classList.remove("isOpen");
  modalOverlay.setAttribute("aria-hidden", "true");
  document.body.style.overflow = "";
  activeKey = null;

  // reset steps
  setStep("date");
  dateInput.value = "";
  answerInput.value = "";
  dateNote.textContent = "";
  answerNote.textContent = "";
  giftActions.innerHTML = "";
}

function setStep(step) {
  stepDate.classList.add("hidden");
  stepQuestion.classList.add("hidden");
  stepGift.classList.add("hidden");

  if (step === "date") stepDate.classList.remove("hidden");
  if (step === "question") stepQuestion.classList.remove("hidden");
  if (step === "gift") stepGift.classList.remove("hidden");
}

function openForDate(key) {
  activeKey = key;
  const data = adventData[key];

  modalBadge.textContent = "–®–∞—Ä–∏–∫";
  modalTitle.textContent = `–î–∞—Ç–∞: ${data.dateLabel}`;
  modalSubtitle.textContent = openedMap[key]
    ? "–≠—Ç–æ—Ç —à–∞—Ä–∏–∫ —É–∂–µ –æ—Ç–∫—Ä—ã–≤–∞–ª–∏ ‚Äî –Ω–æ —Ç—ã –º–æ–∂–µ—à—å –ø—Ä–æ–π—Ç–∏ –≤–æ–ø—Ä–æ—Å –µ—â—ë —Ä–∞–∑."
    : "–ü—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ —Ç—ã –æ—Ç–∫—Ä—ã–≤–∞–µ—à—å –µ–≥–æ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –¥–µ–Ω—å.";

  dateNote.textContent = "";
  answerNote.textContent = "";
  setStep("date");
  openModal();

  setTimeout(() => dateInput.focus(), 50);
}

/* ===========================
   –ü–†–û–í–ï–†–ö–ê –î–ê–¢–´
   =========================== */

function checkDate() {
  if (!activeKey) return;
  const userIso = parseUserDate(dateInput.value);

  if (!userIso) {
    dateNote.textContent = "–•–º‚Ä¶ —Ñ–æ—Ä–º–∞—Ç –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω. –ü—Ä–∏–º–µ—Ä: 15.12.2025 –∏–ª–∏ 2025-12-15";
    dateNote.style.color = "rgba(255,255,255,0.72)";
    return;
  }

  if (userIso !== activeKey) {
    dateNote.textContent = `–°–µ–≥–æ–¥–Ω—è —É —Ç–µ–±—è: ${formatDateLabel(userIso)}. –ê —ç—Ç–æ—Ç —à–∞—Ä–∏–∫ –∂–¥—ë—Ç: ${formatDateLabel(activeKey)} ‚ùÑÔ∏è`;
    dateNote.style.color = "rgba(255,170,170,0.95)";
    return;
  }

  // –û–ö
  const data = adventData[activeKey];
  modalBadge.textContent = "–ü–∏—Å—å–º–æ";
  modalTitle.textContent = `–®–∞—Ä–∏–∫ ${data.dateLabel}`;
  modalSubtitle.textContent = "–û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–∏—Å—å–º–æ‚Ä¶";

  letterDate.textContent = data.dateLabel;
  questionText.textContent = data.question;

  answerInput.value = "";
  answerNote.textContent = "";
  setStep("question");
  setTimeout(() => answerInput.focus(), 50);
}

/* ===========================
   –ü–†–û–í–ï–†–ö–ê –û–¢–í–ï–¢–ê + –ü–û–î–ê–†–û–ö
   =========================== */

function checkAnswer() {
  if (!activeKey) return;
  const data = adventData[activeKey];

  const user = normalizeText(answerInput.value);
  if (!user) {
    answerNote.textContent = "–ù—É–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å –æ—Ç–≤–µ—Ç üôÇ";
    answerNote.style.color = "rgba(255,255,255,0.78)";
    return;
  }

  const ok = (data.answers || []).map(normalizeText).includes(user);

  if (!ok) {
    answerNote.textContent = "–ü–æ—á—Ç–∏! –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ ‚ú®";
    answerNote.style.color = "rgba(255,170,170,0.95)";
    return;
  }

  // –ü–æ–±–µ–¥–∞
  openedMap[activeKey] = true;
  saveOpened(openedMap);
  createOrnaments();

  showGift(data);
}

function showGift(data) {
  modalBadge.textContent = "–ü–æ–¥–∞—Ä–æ–∫";
  modalTitle.textContent = `–û—Ç–∫—Ä—ã—Ç–æ: ${data.dateLabel}`;
  modalSubtitle.textContent = "–¢—ã –æ—Ç–≤–µ—Ç–∏–ª(–∞) –ø—Ä–∞–≤–∏–ª—å–Ω–æ ‚Äî –≤–æ—Ç —Ç–≤–æ–π –ø–æ–¥–∞—Ä–æ–∫!";

  giftNameEl.textContent = data.giftName || "–ü–æ–¥–∞—Ä–æ–∫";
  const type = giftTypeByUrl(data.giftUrl, data.giftName);

  let desc = "–û—Ç–∫—Ä–æ–π –ø–æ –∫–Ω–æ–ø–∫–µ –Ω–∏–∂–µ.";
  if (type === "pdf") desc = "PDF –Ω–∞ Google Drive ‚Äî –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –≤ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ.";
  if (type === "audio") desc = "–ê—É–¥–∏–æ –Ω–∞ Google Drive ‚Äî –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –≤ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ.";
  if (type === "spotify") desc = "–ü–ª–µ–π–ª–∏—Å—Ç Spotify ‚Äî –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ.";
  if (type === "youtube") desc = "YouTube ‚Äî –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ.";
  giftDescEl.textContent = desc;

  giftActions.innerHTML = "";

  const a = document.createElement("a");
  a.className = "linkBtn";
  a.href = data.giftUrl;
  a.target = "_blank";
  a.rel = "noopener noreferrer";
  a.textContent = "–û—Ç–∫—Ä—ã—Ç—å –ø–æ–¥–∞—Ä–æ–∫";
  giftActions.appendChild(a);

  setStep("gift");
}

/* ===========================
   –ö–ù–û–ü–ö–ò / –ó–ê–ö–†–´–¢–ò–ï
   =========================== */

btnCheckDate.addEventListener("click", checkDate);
btnCancel.addEventListener("click", closeModal);
modalClose.addEventListener("click", closeModal);
btnBack.addEventListener("click", () => setStep("date"));
btnCheckAnswer.addEventListener("click", checkAnswer);
btnCloseAfterGift.addEventListener("click", closeModal);

modalOverlay.addEventListener("click", (e) => {
  if (e.target === modalOverlay) closeModal();
});

document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") {
    if (modalOverlay.classList.contains("isOpen")) closeModal();
    if (howOverlay.classList.contains("isOpen")) closeHow();
  }
  if (e.key === "Enter" && modalOverlay.classList.contains("isOpen")) {
    // Enter: —É–¥–æ–±–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ —à–∞–≥–∞–º
    if (!stepDate.classList.contains("hidden")) checkDate();
    else if (!stepQuestion.classList.contains("hidden")) checkAnswer();
  }
});

// How modal
function openHow() {
  howOverlay.classList.add("isOpen");
  howOverlay.setAttribute("aria-hidden", "false");
  document.body.style.overflow = "hidden";
}
function closeHow() {
  howOverlay.classList.remove("isOpen");
  howOverlay.setAttribute("aria-hidden", "true");
  document.body.style.overflow = "";
}

btnHow.addEventListener("click", openHow);
howClose.addEventListener("click", closeHow);
howOk.addEventListener("click", closeHow);
howOverlay.addEventListener("click", (e) => {
  if (e.target === howOverlay) closeHow();
});

// Reset
btnReset.addEventListener("click", () => {
  openedMap = {};
  saveOpened(openedMap);
  createOrnaments();
  alert("–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–±—Ä–æ—à–µ–Ω. –í—Å–µ —à–∞—Ä–∏–∫–∏ —Å–Ω–æ–≤–∞ ¬´–∑–∞–∫—Ä—ã—Ç—ã¬ª ‚ùÑÔ∏è");
});

/* ===========================
   INIT
   =========================== */

createOrnaments();
