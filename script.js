/* ===========================
   Ğ”ĞĞĞĞ«Ğ• ĞĞ”Ğ’Ğ•ĞĞ¢Ğ
   =========================== */

const adventData = {
  "2025-12-15": {
    dateLabel: "15.12.2025",
    question: "ĞšĞ°ĞºĞ¾Ğµ Ñ‚Ñ€Ğ°Ğ½ÑĞ¿Ğ¾Ñ€Ñ‚Ğ½Ğ¾Ğµ ÑÑ€ĞµĞ´ÑÑ‚Ğ²Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ Ğ“Ñ€Ğ¸Ğ½Ñ‡ Ğ´Ğ»Ñ ĞºÑ€Ğ°Ğ¶Ğ¸ Ğ¿Ğ¾Ğ´Ğ°Ñ€ĞºĞ¾Ğ²?",
    answers: ["ÑĞ°Ğ½Ğ¸"],
    giftUrl: "https://drive.google.com/file/d/15Ws-FihOM6pe0pejVdbqxKuJ5cLJqkfN/view?usp=sharing"
  },
  "2025-12-16": {
    dateLabel: "16.12.2025",
    question: "Ğ’ ĞºĞ°ĞºĞ¾Ğ¹ ÑÑ‚Ñ€Ğ°Ğ½Ğµ Ğ½Ğ° ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ³Ğ¾Ğ´ Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚Ğ¾ ĞµÑÑ‚ÑŒ 12 Ğ²Ğ¸Ğ½Ğ¾Ğ³Ñ€Ğ°Ğ´Ğ¸Ğ½ Ğ¿Ğ¾Ğ´ Ğ±Ğ¾Ğ¹ ĞºÑƒÑ€Ğ°Ğ½Ñ‚Ğ¾Ğ², Ğ·Ğ°Ğ³Ğ°Ğ´Ñ‹Ğ²Ğ°Ñ Ğ¶ĞµĞ»Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ° ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ¼ĞµÑÑÑ†?",
    answers: ["Ğ¸ÑĞ¿Ğ°Ğ½Ğ¸Ñ"],
    giftUrl: "https://drive.google.com/file/d/1Gq0gTz6OIIeFxqNUfeRG_0HQ3DkDCYwQ/view?usp=sharing"
  },
  "2025-12-17": {
    dateLabel: "17.12.2025",
    question: "ĞšĞ°Ğº Ğ·Ğ¾Ğ²ÑƒÑ‚ Ğ³ĞµÑ€Ğ¾Ñ Ğ´Ğ¸ÑĞ½ĞµĞµĞ²ÑĞºĞ¾Ğ³Ğ¾ Ğ¼ÑƒĞ»ÑŒÑ‚Ğ¸ĞºĞ°, ĞºĞ¾Ğ¼Ñƒ Ğ¿Ñ€Ğ¸Ğ½Ğ°Ğ´Ğ»ĞµĞ¶Ğ°Ñ‚ ÑĞ»Ğ¾Ğ²Ğ° \"ĞĞ¹, ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸Ñ‚Ğµ, Ñ - ÑˆĞ°ÑˆĞ»Ñ‹Ñ‡Ğ¾Ğº!\" ?",
    answers: ["Ğ¾Ğ»Ğ°Ñ„"],
    giftUrl: "https://open.spotify.com/playlist/3laBYMG32oGIpMmKNoFUDs"
  },
  "2025-12-18": {
    dateLabel: "18.12.2025",
    question: "Ğ’ ĞºĞ°ĞºĞ¾Ğ¹ ÑÑ‚Ñ€Ğ°Ğ½Ğµ Ğ½Ğ° ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ³Ğ¾Ğ´ (ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ³Ğ¾Ğ´ Ğ¿Ğ¾ Ğ»ÑƒĞ½Ğ½Ğ¾Ğ¼Ñƒ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ñ) Ğ½ĞµĞ»ÑŒĞ·Ñ Ğ¿Ğ¾Ğ´Ğ¼ĞµÑ‚Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ», Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğµ Ğ²Ñ‹Ğ¼ĞµÑÑ‚Ğ¸ ÑƒĞ´Ğ°Ñ‡Ñƒ?",
    answers: ["ĞºĞ¸Ñ‚Ğ°Ğ¹"],
    giftUrl: "https://drive.google.com/file/d/1YsunO894S2STDpmq020xCcDOu-388mMP/view?usp=sharing" 
  },
  "2025-12-19": {
    dateLabel: "19.12.2025",
    question: "Ğ§Ñ‚Ğ¾ Ğ² Ğ˜ÑĞ»Ğ°Ğ½Ğ´Ğ¸Ğ¸ Ğ´ĞµÑ‚Ğ¸ ĞºĞ»Ğ°Ğ´ÑƒÑ‚ Ğ½Ğ° Ğ¿Ğ¾Ğ´Ğ¾ĞºĞ¾Ğ½Ğ½Ğ¸Ğº Ğ² Ñ€Ğ¾Ğ¶Ğ´ĞµÑÑ‚Ğ²ĞµĞ½ÑĞºÑƒÑ Ğ½Ğ¾Ñ‡ÑŒ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ñ‚ÑƒĞ´Ğ° Ğ¿Ğ¾Ğ¿Ğ°Ğ»Ğ¸ Ğ¿Ğ¾Ğ´Ğ°Ñ€ĞºĞ¸ Ğ¾Ñ‚ 13-Ñ‚Ğ¸ Ğ¼ĞµÑÑ‚Ğ½Ñ‹Ñ… Ğ”ĞµĞ´Ğ¾Ğ² ĞœĞ¾Ñ€Ğ¾Ğ·Ğ¾Ğ²?",
    answers: ["Ğ±Ğ¾Ñ‚Ğ¸Ğ½Ğ¾Ğº"],
    giftUrl: "https://www.youtube.com/watch?v=1Xn5p6fVzWI&list=RD1Xn5p6fVzWI&start_radio=1"
  },
  "2025-12-20": {
    dateLabel: "20.12.2025",
    question: "ĞšÑ‚Ğ¾ Ğ¸Ğ· Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶ĞµĞ¹ Â«Ğ“Ğ°Ñ€Ñ€Ğ¸ ĞŸĞ¾Ñ‚Ñ‚ĞµÑ€Ğ°Â» Ğ¿Ğ¾Ğ´Ğ°Ñ€Ğ¸Ğ» Ğ“Ğ°Ñ€Ñ€Ğ¸ Ğ½Ğ° Ğ Ğ¾Ğ¶Ğ´ĞµÑÑ‚Ğ²Ğ¾ ĞœĞ°Ğ½Ñ‚Ğ¸Ñ-Ğ½ĞµĞ²Ğ¸Ğ´Ğ¸Ğ¼ĞºÑƒ?",
    answers: ["Ğ´Ğ°Ğ¼Ğ±Ğ»Ğ´Ğ¾Ñ€"],
    giftUrl: "https://open.spotify.com/playlist/7bNg2XDsAQQ9fVv37lV9TA"
  },
  "2025-12-21": {
    dateLabel: "21.12.2025",
    question: "Ğ’ ĞºĞ°ĞºĞ¾Ğ¹ ÑÑ‚Ñ€Ğ°Ğ½Ğµ Ğ½Ğ° Ğ Ğ¾Ğ¶Ğ´ĞµÑÑ‚Ğ²Ğ¾ Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚Ğ¾ ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ½Ğ° ÑÑ‚Ğ¾Ğ» Ğ¶Ğ°Ñ€ĞµĞ½Ğ¾Ğ³Ğ¾... ĞºĞ°Ñ€Ğ¿Ğ°?",
    answers: ["Ñ‡ĞµÑ…Ğ¸Ñ"],
    giftUrl: "https://drive.google.com/file/d/1cGEqLKXtkD6i3eiJXWARiX0jRw77jsWa/view?usp=sharing"
  },
  "2025-12-22": {
    dateLabel: "22.12.2025",
    question: "ĞšĞ°ĞºĞ¾Ğ¹ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶ Ğ¸Ğ· Â«Ğ’Ğ»Ğ°ÑÑ‚ĞµĞ»Ğ¸Ğ½Ğ° ĞšĞ¾Ğ»ĞµÑ†Â» ÑÑ‚Ğ°Ğ» Ñ€Ğ¾Ğ¶Ğ´ĞµÑÑ‚Ğ²ĞµĞ½ÑĞºĞ¸Ğ¼ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ¼ Ğ´Ğ»Ñ Ñ„Ğ°Ğ½Ğ°Ñ‚Ğ¾Ğ² ?",
    answers: ["Ğ³ĞµĞ½Ğ´Ğ°Ğ»ÑŒÑ„"],
    giftUrl: "https://evgen1910.github.io/dima-workday-game/"
  },
  "2025-12-23": {
    dateLabel: "23.12.2025",
    question: "Ğ’ ĞºĞ°ĞºĞ¾Ğ¹ ĞµĞ²Ñ€Ğ¾Ğ¿ĞµĞ¹ÑĞºĞ¾Ğ¹ ÑÑ‚Ñ€Ğ°Ğ½Ğµ Ğ½Ğ° Ğ Ğ¾Ğ¶Ğ´ĞµÑÑ‚Ğ²Ğ¾ Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚Ğ¾ Ğ¿Ñ€ÑÑ‚Ğ°Ñ‚ÑŒ Ğ¼ĞµÑ‚Ğ»Ñƒ â€” Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ²ĞµĞ´ÑŒĞ¼Ñ‹ Ğ½Ğµ ÑƒĞ½ĞµÑĞ»Ğ¸ ĞµÑ‘ Ğ´Ğ»Ñ ÑĞ²Ğ¾Ğ¸Ñ… Ğ¿Ğ¾Ğ»Ñ‘Ñ‚Ğ¾Ğ²?",
    answers: ["Ğ½Ğ¾Ñ€Ğ²ĞµĞ³Ğ¸Ñ"],
    giftUrl: "https://drive.google.com/file/d/1Xb02kf_3HeF7vxIFlRBh5FQmsPp7cdIl/view?usp=sharing"
  },
  "2025-12-24": {
    dateLabel: "24.12.2025",
    question: "Ğ¡Ğ°Ğ¼Ñ‹Ğ¹ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾Ğ´Ğ½Ğ¸Ğ¹ Ñ„Ğ¸Ğ»ÑŒĞ¼ Ñ Ğ‘Ñ€ÑÑÑĞ¾Ğ¼ Ğ£Ğ¸Ğ»Ğ»Ğ¸ÑĞ¾Ğ¼: (Ğ² 2 ÑĞ»Ğ¾Ğ²Ğ°)?",
    answers: ["ĞºÑ€ĞµĞ¿ĞºĞ¸Ğ¹ Ğ¾Ñ€ĞµÑˆĞµĞº"],
    giftUrl: "https://drive.google.com/file/d/1FYMrOj9v5IgLeGXE1dEPpVNIkOhx_pdu/view?usp=sharing"
  },
  "2025-12-25": {
    dateLabel: "25.12.2025",
    question: "Ğ’ ĞºĞ°ĞºĞ¾Ğ¹ ÑÑ‚Ñ€Ğ°Ğ½Ğµ Ğ³Ğ»Ğ°Ğ²Ğ½Ñ‹Ğ¹ Ğ·Ğ¸Ğ¼Ğ½Ğ¸Ğ¹ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶ â€” ĞºĞ¾Ğ·Ñ‘Ğ», Ğ° Ğ½Ğµ Ğ”ĞµĞ´ ĞœĞ¾Ñ€Ğ¾Ğ·?",
    answers: ["Ñ„Ğ¸Ğ½Ğ»ÑĞ½Ğ´Ğ¸Ñ"],
    giftUrl: "https://open.spotify.com/playlist/6ESOAs0TbqHaCpePLDnMTU"
  },
  "2025-12-26": {
    dateLabel: "26.12.2025",
    question: "Ğ’ ĞºĞ°ĞºĞ¾Ğ¹ ÑÑ‚Ñ€Ğ°Ğ½Ğµ Ğ² Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾Ğ´Ğ½ÑÑ Ğ½Ğ¾Ñ‡ÑŒ Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚Ğ¾ Ğ²Ñ‹Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°Ñ‚ÑŒ Ğ¸Ğ· Ğ¾ĞºĞ¾Ğ½ ÑÑ‚Ğ°Ñ€ÑƒÑ Ğ¼ĞµĞ±ĞµĞ»ÑŒ Ğ¸ Ğ½ĞµĞ½ÑƒĞ¶Ğ½Ñ‹Ğµ Ğ²ĞµÑ‰Ğ¸?",
    answers: ["Ğ¸Ñ‚Ğ°Ğ»Ğ¸Ñ"],
    giftUrl: "https://drive.google.com/file/d/1EnJEarD92D3esdQSyLXnCbisLlor28eq/view?usp=sharing"
  },
  "2025-12-27": {
    dateLabel: "27.12.2025",
    question: "ĞšĞ°Ğº Ğ·Ğ¾Ğ²ÑƒÑ‚ Â«Ğ·Ğ»Ğ¾Ğ³Ğ¾Â» Ğ´Ğ²Ğ¾Ğ¹Ğ½Ğ¸ĞºĞ° Ğ¡Ğ°Ğ½Ñ‚Ñ‹ Ğ² Ğ°Ğ²ÑÑ‚Ñ€Ğ¸Ğ¹ÑĞºĞ¾Ğ¹ Ğ¸ Ğ½ĞµĞ¼ĞµÑ†ĞºĞ¾Ğ¹ Ñ‚Ñ€Ğ°Ğ´Ğ¸Ñ†Ğ¸ÑÑ…, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ½Ğ°ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ½ĞµĞ¿Ğ¾ÑĞ»ÑƒÑˆĞ½Ñ‹Ñ… Ğ´ĞµÑ‚ĞµĞ¹?",
    answers: ["ĞºÑ€Ğ°Ğ¼Ğ¿ÑƒÑ"],
    giftUrl: "https://drive.google.com/file/d/19sBvPGZh1T0cX7gQtxe-yziUkk1z2SO9/view?usp=sharing"
  },
  "2025-12-28": {
    dateLabel: "28.12.2025",
    question: "Ğ’ ĞºĞ°ĞºĞ¾Ğ¹ Ğ°Ğ·Ğ¸Ğ°Ñ‚ÑĞºĞ¾Ğ¹ ÑÑ‚Ñ€Ğ°Ğ½Ğµ Ğ½Ğ° ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ³Ğ¾Ğ´ Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚Ğ¾ Ğ¾Ñ‚Ğ¿ÑƒÑĞºĞ°Ñ‚ÑŒ Ğ¶Ğ¸Ğ²Ñ‹Ñ… ĞºĞ°Ñ€Ğ¿Ğ¾Ğ² Ğ² Ñ€ĞµĞºÑƒ, ÑÑ‡Ğ¸Ñ‚Ğ°Ñ, Ñ‡Ñ‚Ğ¾ Ğ½Ğ° Ğ½Ğ¸Ñ… ÑƒĞ¿Ğ»Ñ‹Ğ²Ğ°ÑÑ‚ Ğ²ÑĞµ Ğ±ĞµĞ´Ñ‹?",
    answers: ["Ğ²ÑŒĞµÑ‚Ğ½Ğ°Ğ¼"],
    giftUrl: "https://open.spotify.com/playlist/4IMcQvry1CFKrJwF2kgw3K"
  },
  "2025-12-29": {
    dateLabel: "29.12.2025",
    question: "ĞšĞ°ĞºĞ¾Ğ¹ Ñ„Ñ€ÑƒĞºÑ‚ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¼ Ğ¿Ğ¾Ğ´Ğ°Ñ€ĞºĞ¾Ğ¼ Ğ½Ğ° ĞºĞ¸Ñ‚Ğ°Ğ¹ÑĞºĞ¸Ğ¹ ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ³Ğ¾Ğ´ ĞºĞ°Ğº Ğ¿Ğ¾Ğ¶ĞµĞ»Ğ°Ğ½Ğ¸Ğµ Ğ±Ğ¾Ğ³Ğ°Ñ‚ÑÑ‚Ğ²Ğ°?",
    answers: ["Ğ¼Ğ°Ğ½Ğ´Ğ°Ñ€Ğ¸Ğ½"],
    giftUrl: "https://drive.google.com/file/d/1E1MhC06ub7Szh9vkmf3003xhjbRcs1Pa/view?usp=sharing"
  },
  "2025-12-30": {
    dateLabel: "30.12.2025",
    question: "ĞšĞ¾Ğ³Ğ¾ ÑÑ‹Ğ³Ñ€Ğ°Ğ» Ñ€Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ğ±Ñ€Ğ°Ñ‚ ĞœĞ°ĞºĞ¾Ğ»ĞµÑ ĞšĞ°Ğ»ĞºĞ¸Ğ½Ğ° Ğ² Ñ„Ğ¸Ğ»ÑŒĞ¼Ğµ ĞĞ´Ğ¸Ğ½ Ğ”Ğ¾Ğ¼Ğ°?",
    answers: ["Ñ„ÑƒĞ»Ğ»ĞµÑ€"],
    giftUrl: "https://open.spotify.com/playlist/6l6AKJhnRefQ1JlanzFf0R"
  },
  "2025-12-31": {
    dateLabel: "31.12.2025",
    question: "ĞšĞµĞ¼ Ğ±Ñ‹Ğ» ĞœĞ¸ÑÑ‚ĞµÑ€ Ğ¥ÑĞ½ĞºĞ¸ Ğ¸Ğ· Ğ¿ĞµÑ€Ğ²Ğ¾Ğ³Ğ¾ Ñ€Ğ¾Ğ¶Ğ´ĞµÑÑ‚Ğ²ĞµĞ½ÑĞºĞ¾Ğ³Ğ¾ ÑĞ¿Ğ¸Ğ·Ğ¾Ğ´Ğ° Ğ®Ğ¶Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ°Ñ€ĞºĞ°?",
    answers: ["ĞºĞ°ĞºĞ°ÑˆĞºĞ°"],
    giftUrl: "https://drive.google.com/file/d/1bygZpTNiGqbyCHQQewskRVoCdu69pcNM/view?usp=sharing"
  },
  "2026-01-01": {
    dateLabel: "01.01.2026",
    question: "Ğ˜Ğ¼Ñ Ğ¶ĞµĞ½Ñ‰Ğ¸Ğ½Ñ‹, ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ°Ñ Ğ¿Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ½Ğ¾ Ğ½Ğ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ñ‚ĞµĞ±Ñ Ğ¶ÑƒĞºĞ¾Ğ¼, Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼Ñƒ Ñ‡Ñ‚Ğ¾ Ñ‚Ñ‹ Ğ–Ğ£Ğš",
    answers: ["Ğ•Ğ²Ğ³ĞµĞ½Ğ¸Ñ"],
    giftUrl: "https://t.me/+KGirTgebLtQ5OGEy"
  }
};

/* Ñ€Ğ°Ğ²Ğ½Ğ¾Ğ¼ĞµÑ€Ğ½Ğ¾ Ğ¿Ğ¾ ÑĞºÑ€Ğ°Ğ½Ñƒ */
const ornamentLayout = [
  { key:"2025-12-15", x: 10, y: 18 },
  { key:"2025-12-16", x: 22, y: 42 },
  { key:"2025-12-17", x: 36, y: 16 },
  { key:"2025-12-18", x: 46, y: 40 },
  { key:"2025-12-19", x: 62, y: 18 },
  { key:"2025-12-20", x: 74, y: 42 },
  { key:"2025-12-21", x: 88, y: 20 },

  { key:"2025-12-22", x: 92, y: 62 },
  { key:"2025-12-23", x: 82, y: 74 },
  { key:"2025-12-24", x: 66, y: 84 },
  { key:"2025-12-25", x: 50, y: 72 },
  { key:"2025-12-26", x: 36, y: 86 },
  { key:"2025-12-27", x: 18, y: 74 },
  { key:"2025-12-28", x: 8,  y: 58 },

  { key:"2025-12-29", x: 50, y: 10 },
  { key:"2025-12-30", x: 30, y: 58 },
  { key:"2025-12-31", x: 58, y: 56 },
  { key:"2026-01-01", x: 70, y: 12 }
];

/* ===========================
   Ğ¥Ğ•Ğ›ĞŸĞ•Ğ Ğ«
   =========================== */

const STORAGE_KEY = "advent2025_opened_v2";

function loadOpened() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    return raw ? JSON.parse(raw) : {};
  } catch {
    return {};
  }
}
function saveOpened(map) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(map));
}

function normalizeText(s) {
  return (s ?? "")
    .toString()
    .trim()
    .toLowerCase()
    .replace(/\s+/g, " ");
}

/* Ğ¿Ñ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚: 8 Ñ†Ğ¸Ñ„Ñ€ DDMMYYYY / DD.MM.YYYY / YYYY-MM-DD */
function parseUserDate(input) {
  const v = (input || "").trim();

  const digits = v.replace(/\D/g, "");
  if (digits.length === 8) {
    const dd = digits.slice(0,2);
    const mm = digits.slice(2,4);
    const yyyy = digits.slice(4,8);
    return `${yyyy}-${mm}-${dd}`;
  }

  const iso = v.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (iso) return `${iso[1]}-${iso[2]}-${iso[3]}`;

  const ru = v.match(/^(\d{2})\.(\d{2})\.(\d{4})$/);
  if (ru) return `${ru[3]}-${ru[2]}-${ru[1]}`;

  return null;
}

function formatDateLabel(iso) {
  const d = adventData[iso]?.dateLabel;
  if (d) return d;
  const m = iso.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  return m ? `${m[3]}.${m[2]}.${m[1]}` : iso;
}

function ballColorClass(idx){
  const palette = ["ball--red","ball--gold","ball--blue","ball--green","ball--pink","ball--violet"];
  return palette[idx % palette.length];
}

/* Ğ¼Ğ°ÑĞºĞ° Ğ²Ğ²Ğ¾Ğ´Ğ°: 15122025 -> 15.12.2025 */
function maskDateInput(el){
  el.addEventListener("input", () => {
    const digits = el.value.replace(/\D/g, "").slice(0, 8);
    let out = digits;
    if (digits.length > 2) out = digits.slice(0,2) + "." + digits.slice(2);
    if (digits.length > 4) out = digits.slice(0,2) + "." + digits.slice(2,4) + "." + digits.slice(4);
    el.value = out;
  });
}

/* ===========================
   DOM
   =========================== */

const ornamentsEl = document.querySelector(".ornaments");

// modal
const modalOverlay = document.getElementById("modalOverlay");
const modalClose = document.getElementById("modalClose");
const modalTitle = document.getElementById("modalTitle");
const modalSubtitle = document.getElementById("modalSubtitle");
const modalBadge = document.getElementById("modalBadge");

const stepDate = document.getElementById("stepDate");
const stepQuestion = document.getElementById("stepQuestion");
const stepGift = document.getElementById("stepGift");

const dateInput = document.getElementById("dateInput");
const btnCheckDate = document.getElementById("btnCheckDate");
const btnCancel = document.getElementById("btnCancel");
const dateNote = document.getElementById("dateNote");

const letterDate = document.getElementById("letterDate");
const questionText = document.getElementById("questionText");
const answerInput = document.getElementById("answerInput");
const btnCheckAnswer = document.getElementById("btnCheckAnswer");
const btnBack = document.getElementById("btnBack");
const answerNote = document.getElementById("answerNote");

const giftActions = document.getElementById("giftActions");
const btnCloseAfterGift = document.getElementById("btnCloseAfterGift");

// how modal
const howOverlay = document.getElementById("howOverlay");
const btnHow = document.getElementById("btnHow");
const howClose = document.getElementById("howClose");
const howOk = document.getElementById("howOk");

// reset
const btnReset = document.getElementById("btnReset");

let openedMap = loadOpened();
let activeKey = null;

/* ===========================
   Ğ Ğ•ĞĞ”Ğ•Ğ  Ğ¨ĞĞ ĞĞ’
   =========================== */

function createOrnaments() {
  ornamentsEl.innerHTML = "";

  ornamentLayout.forEach((item, idx) => {
    const data = adventData[item.key];
    if (!data) return;

    const wrap = document.createElement("button");
    wrap.className = "ornament";
    wrap.type = "button";
    wrap.style.left = `${item.x}%`;
    wrap.style.top = `${item.y}%`;
    wrap.style.transform = `translate(-50%, -50%)`;
    wrap.setAttribute("aria-label", `Ğ¨Ğ°Ñ€Ğ¸Ğº ${data.dateLabel}`);

    const ball = document.createElement("div");
    ball.className = "ball " + ballColorClass(idx);

    if (openedMap[item.key]) {
      ball.classList.add("ball--opened");
    }

    const label = document.createElement("div");
    label.className = "ballLabel";
    label.textContent = data.dateLabel;

    wrap.appendChild(ball);
    wrap.appendChild(label);

    wrap.addEventListener("click", () => openForDate(item.key));

    ornamentsEl.appendChild(wrap);
  });
}

/* ===========================
   ĞœĞĞ”ĞĞ›ĞšĞ
   =========================== */

function openModal() {
  modalOverlay.classList.add("isOpen");
  modalOverlay.setAttribute("aria-hidden", "false");
  document.body.style.overflow = "hidden";
}

function closeModal() {
  modalOverlay.classList.remove("isOpen");
  modalOverlay.setAttribute("aria-hidden", "true");
  document.body.style.overflow = "";
  activeKey = null;

  setStep("date");
  dateInput.value = "";
  answerInput.value = "";
  dateNote.textContent = "";
  answerNote.textContent = "";
  giftActions.innerHTML = "";
}

function setStep(step) {
  stepDate.classList.add("hidden");
  stepQuestion.classList.add("hidden");
  stepGift.classList.add("hidden");

  if (step === "date") stepDate.classList.remove("hidden");
  if (step === "question") stepQuestion.classList.remove("hidden");
  if (step === "gift") stepGift.classList.remove("hidden");
}

function openForDate(key) {
  activeKey = key;
  const data = adventData[key];

  modalBadge.textContent = "Ğ¨Ğ°Ñ€Ğ¸Ğº";
  modalTitle.textContent = `Ğ”Ğ°Ñ‚Ğ°: ${data.dateLabel}`;
  modalSubtitle.textContent = openedMap[key]
    ? "Ğ­Ñ‚Ğ¾Ñ‚ ÑˆĞ°Ñ€Ğ¸Ğº ÑƒĞ¶Ğµ Ğ¾Ñ‚ĞºÑ€Ñ‹Ğ²Ğ°Ğ»Ğ¸ â€” Ğ½Ğ¾ Ñ‚Ñ‹ Ğ¼Ğ¾Ğ¶ĞµÑˆÑŒ Ğ¿Ñ€Ğ¾Ğ¹Ñ‚Ğ¸ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ ĞµÑ‰Ñ‘ Ñ€Ğ°Ğ·."
    : "ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ğ¼, Ñ‡Ñ‚Ğ¾ Ñ‚Ñ‹ Ğ¾Ñ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑˆÑŒ ĞµĞ³Ğ¾ Ğ² Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ.";

  dateNote.textContent = "";
  answerNote.textContent = "";
  setStep("date");
  openModal();
  setTimeout(() => dateInput.focus(), 60);
}

/* ===========================
   ĞŸĞ ĞĞ’Ğ•Ğ ĞšĞ Ğ”ĞĞ¢Ğ«
   =========================== */

function checkDate() {
  if (!activeKey) return;
  const userIso = parseUserDate(dateInput.value);

  if (!userIso) {
    dateNote.textContent = "ĞĞµ Ñ€Ğ°ÑĞ¿Ğ¾Ğ·Ğ½Ğ°Ğ»Ğ° Ğ´Ğ°Ñ‚Ñƒ. ĞœĞ¾Ğ¶Ğ½Ğ¾ 8 Ñ†Ğ¸Ñ„Ñ€: 15122025";
    dateNote.style.color = "rgba(255,255,255,0.78)";
    return;
  }

  if (userIso !== activeKey) {
    dateNote.textContent = `Ğ­Ñ‚Ğ¾Ñ‚ ÑˆĞ°Ñ€Ğ¸Ğº Ğ¶Ğ´Ñ‘Ñ‚: ${formatDateLabel(activeKey)} â„ï¸`;
    dateNote.style.color = "rgba(255,170,170,0.95)";
    return;
  }

  const data = adventData[activeKey];
  modalBadge.textContent = "ĞŸĞ¸ÑÑŒĞ¼Ğ¾";
  modalTitle.textContent = `Ğ¨Ğ°Ñ€Ğ¸Ğº ${data.dateLabel}`;
  modalSubtitle.textContent = "ĞÑ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¿Ğ¸ÑÑŒĞ¼Ğ¾â€¦";

  letterDate.textContent = data.dateLabel;
  questionText.textContent = data.question;

  answerInput.value = "";
  answerNote.textContent = "";
  setStep("question");
  setTimeout(() => answerInput.focus(), 60);
}

/* ===========================
   ĞŸĞ ĞĞ’Ğ•Ğ ĞšĞ ĞĞ¢Ğ’Ğ•Ğ¢Ğ + ĞŸĞĞ”ĞĞ ĞĞš
   =========================== */

function checkAnswer() {
  if (!activeKey) return;
  const data = adventData[activeKey];

  const user = normalizeText(answerInput.value);
  if (!user) {
    answerNote.textContent = "ĞÑƒĞ¶Ğ½Ğ¾ Ğ½Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ¾Ñ‚Ğ²ĞµÑ‚ ğŸ™‚";
    answerNote.style.color = "rgba(255,255,255,0.80)";
    return;
  }

  const ok = (data.answers || []).map(normalizeText).includes(user);

  if (!ok) {
    answerNote.textContent = "ĞŸĞ¾Ñ‡Ñ‚Ğ¸! ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹ ĞµÑ‰Ñ‘ Ñ€Ğ°Ğ· âœ¨";
    answerNote.style.color = "rgba(255,170,170,0.95)";
    return;
  }

  openedMap[activeKey] = true;
  saveOpened(openedMap);
  createOrnaments();

  showGift(data);
}

function showGift(data) {
  modalBadge.textContent = "ĞŸĞ¾Ğ´Ğ°Ñ€Ğ¾Ğº";
  modalTitle.textContent = `ĞÑ‚ĞºÑ€Ñ‹Ñ‚Ğ¾: ${data.dateLabel}`;
  modalSubtitle.textContent = "Ğ¡ÑÑ€Ğ¿Ñ€Ğ¸Ğ· Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ ğŸ";

  giftActions.innerHTML = "";

  const a = document.createElement("a");
  a.className = "linkBtn";
  a.href = data.giftUrl;
  a.target = "_blank";
  a.rel = "noopener noreferrer";
  a.textContent = "ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¿Ğ¾Ğ´Ğ°Ñ€Ğ¾Ğº";
  giftActions.appendChild(a);

  setStep("gift");
}

/* ===========================
   Ğ¡Ğ›Ğ£Ğ¨ĞĞ¢Ğ•Ğ›Ğ˜
   =========================== */

btnCheckDate.addEventListener("click", checkDate);
btnCancel.addEventListener("click", closeModal);
modalClose.addEventListener("click", closeModal);

btnBack.addEventListener("click", () => setStep("date"));
btnCheckAnswer.addEventListener("click", checkAnswer);
btnCloseAfterGift.addEventListener("click", closeModal);

modalOverlay.addEventListener("click", (e) => {
  if (e.target === modalOverlay) closeModal();
});

document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") {
    if (modalOverlay.classList.contains("isOpen")) closeModal();
    if (howOverlay.classList.contains("isOpen")) closeHow();
  }
  if (e.key === "Enter" && modalOverlay.classList.contains("isOpen")) {
    if (!stepDate.classList.contains("hidden")) checkDate();
    else if (!stepQuestion.classList.contains("hidden")) checkAnswer();
  }
});

// how modal
function openHow() {
  howOverlay.classList.add("isOpen");
  howOverlay.setAttribute("aria-hidden", "false");
  document.body.style.overflow = "hidden";
}
function closeHow() {
  howOverlay.classList.remove("isOpen");
  howOverlay.setAttribute("aria-hidden", "true");
  document.body.style.overflow = "";
}
btnHow.addEventListener("click", openHow);
howClose.addEventListener("click", closeHow);
howOk.addEventListener("click", closeHow);
howOverlay.addEventListener("click", (e) => {
  if (e.target === howOverlay) closeHow();
});

// reset
btnReset.addEventListener("click", () => {
  openedMap = {};
  saveOpened(openedMap);
  createOrnaments();
  alert("ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑÑ ÑĞ±Ñ€Ğ¾ÑˆĞµĞ½. Ğ’ÑĞµ ÑˆĞ°Ñ€Ğ¸ĞºĞ¸ ÑĞ½Ğ¾Ğ²Ğ° Â«Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ñ‹Â» â„ï¸");
});

/* init */
maskDateInput(dateInput);
createOrnaments();



